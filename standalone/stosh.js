"use strict";var stosh=(()=>{var D=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var B=(d,e)=>{for(var t in e)D(d,t,{get:e[t],enumerable:!0})},G=(d,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of C(e))!U.call(d,n)&&n!==t&&D(d,n,{get:()=>e[n],enumerable:!(r=A(e,n))||r.enumerable});return d};var Y=d=>G(D({},"__esModule",{value:!0}),d);var z={};B(z,{Stosh:()=>E,stosh:()=>k});var m=class{constructor(){this.store=new Map}get length(){return this.store.size}clear(){this.store.clear()}getItem(e){return this.store.get(e)??null}key(e){return Array.from(this.store.keys())[e]??null}removeItem(e){this.store.delete(e)}setItem(e,t){this.store.set(e,t)}},g=class{get length(){return document.cookie?document.cookie.split(";").length:0}clear(){document.cookie.split(";").map(e=>e.trim().split("=")[0]).filter(Boolean).forEach(e=>this.removeItem(decodeURIComponent(e)))}getItem(e){let t=encodeURIComponent(e)+"=";return document.cookie.split(";").map(r=>r.trim()).find(r=>r.startsWith(t))?.slice(t.length)?decodeURIComponent(document.cookie.split(";").map(r=>r.trim()).find(r=>r.startsWith(t)).slice(t.length)):null}key(e){let t=document.cookie.split(";");if(e<0||e>=t.length)return null;let[r]=t[e].split("=");return r?decodeURIComponent(r.trim()):null}removeItem(e,t){document.cookie=R(e,"",{...t,expire:"Thu, 01 Jan 1970 00:00:00 GMT"})}setItem(e,t,r){document.cookie=R(e,t,r)}};function R(d,e,t){let r=[`${encodeURIComponent(d)}=${encodeURIComponent(e)}`,`path=${t?.path??"/"}`];if(t?.domain&&r.push(`domain=${t.domain}`),t?.expire){let n=typeof t.expire=="string"?t.expire:typeof t.expire=="number"?new Date(Date.now()+t.expire).toUTCString():t.expire.toUTCString();r.push(`expires=${n}`)}return t?.secure&&r.push("secure"),t?.sameSite&&r.push(`samesite=${t.sameSite}`),r.join("; ")}var _=class{constructor(e){if(typeof indexedDB>"u"||typeof indexedDB.open!="function")throw new Error("IndexedDB is not supported or 'open' method is missing in this environment.");this.dbName=`stoshDB_${e}`,this.storeName="stosh_store",this.dbPromise=this.open()}getStoreName(){return this.storeName}getDbPromise(){return this.dbPromise}open(){return new Promise((e,t)=>{try{if(typeof indexedDB>"u"||typeof indexedDB.open!="function")return t(new Error("IndexedDB became unavailable or invalid before open call."));let r=indexedDB.open(this.dbName,1);r.onupgradeneeded=n=>{let s=n.target.result;s.objectStoreNames.contains(this.storeName)||s.createObjectStore(this.storeName)},r.onsuccess=n=>{e(n.target.result)},r.onerror=n=>{console.error("[stosh] IndexedDB open request error:",n.target.error),t(n.target.error)}}catch(r){console.error("[stosh] Critical error calling indexedDB.open:",r),t(r)}})}async getItem(e){let t=await this.dbPromise;return new Promise((r,n)=>{let o=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);o.onsuccess=()=>r(o.result??null),o.onerror=()=>n(new Error("IndexedDB getItem error: "+o.error))})}async setItem(e,t){let r=await this.dbPromise;return new Promise((n,s)=>{let l=r.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(t,e);l.onsuccess=()=>n(),l.onerror=()=>s(new Error("IndexedDB setItem error: "+l.error))})}async removeItem(e){let t=await this.dbPromise;return new Promise((r,n)=>{let o=t.transaction(this.storeName,"readwrite").objectStore(this.storeName).delete(e);o.onsuccess=()=>r(),o.onerror=()=>n(new Error("IndexedDB removeItem error: "+o.error))})}async clear(){let e=await this.dbPromise;return new Promise((t,r)=>{let n=e.transaction(this.storeName,"readwrite"),i=n.objectStore(this.storeName).clear();i.onsuccess=()=>t(),i.onerror=()=>r(i.error),n.oncomplete=()=>t(),n.onerror=()=>r(n.error),n.onabort=()=>r(n.error||new Error("Transaction aborted"))})}async getAllKeys(){let e=await this.dbPromise;return new Promise((t,r)=>{let i=e.transaction(this.storeName,"readonly").objectStore(this.storeName).getAllKeys();i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)})}async batchSet(e){if(!e.length)return;let t=await this.dbPromise;return new Promise((r,n)=>{let s=t.transaction(this.storeName,"readwrite"),i=s.objectStore(this.storeName),o=e.length;e.forEach(({key:l,value:c})=>{let a=i.put(c,l);a.onsuccess=()=>{o--},a.onerror=()=>{s.error||(n(a.error),s.abort())}}),s.oncomplete=()=>r(),s.onerror=()=>n(s.error),s.onabort=()=>n(s.error||new Error("Transaction aborted"))})}async batchGet(e){if(!e.length)return[];let t=await this.dbPromise;return new Promise((r,n)=>{let s=t.transaction(this.storeName,"readonly"),i=s.objectStore(this.storeName),o=new Array(e.length).fill(null),l=new Map;e.forEach((a,h)=>{l.has(a)||l.set(a,[]),l.get(a).push(h)});let c=l.size;if(c===0){r(o);return}l.forEach((a,h)=>{let S=i.get(h);S.onsuccess=()=>{a.forEach(f=>o[f]=S.result??null),c--},S.onerror=()=>{s.error||n(S.error)}}),s.oncomplete=()=>r(o),s.onerror=()=>n(s.error),s.onabort=()=>n(s.error||new Error("Transaction aborted"))})}async batchRemove(e){if(!e.length)return;let t=await this.dbPromise;return new Promise((r,n)=>{let s=t.transaction(this.storeName,"readwrite"),i=s.objectStore(this.storeName),o=e.length;e.forEach(l=>{let c=i.delete(l);c.onsuccess=()=>{o--},c.onerror=()=>{s.error||(n(c.error),s.abort())}}),s.oncomplete=()=>r(),s.onerror=()=>n(s.error),s.onabort=()=>n(s.error||new Error("Transaction aborted"))})}};var u=class{constructor(){this.chain=[]}use(e){this.chain.push(e)}runSync(e,t){let r=-1,n=!1,s=()=>{if(n)throw new Error("next() called multiple times in middleware");n=!0,r++,r<this.chain.length?(n=!1,this.chain[r](e,s)):t(e)};s()}async run(e,t){let r=0,n=!1,s=async()=>{if(n)throw new Error("next() called multiple times in middleware");if(n=!0,r<this.chain.length){n=!1;let i=this.chain[r++];await i(e,s)}else await t(e)};await s()}};var y="idb",v="local",b="session",T="cookie",p="memory",P=[y,v,b,T,p],x=[v,b,T,p],I="get",O="set",M="remove";var E=class d{static get isSSR(){return typeof window>"u"}constructor(e){let t=null,r=!1,n=[y,v,b,T,p];if(e?.type&&!n.includes(e.type))throw new Error(`Unsupported storage type: ${e.type}`);let s=e?.type&&e.type!==y?!0:e?.priority?e.priority.every(o=>o!==y):!1,i=e?.priority||(e?.type?[e.type]:s?x:P);if(typeof window>"u"){r=!0,this.storage=new m,this.isMemoryFallback=!0,this.namespace=e?.namespace?e.namespace+":":"",this.serializeFn=e?.serialize||JSON.stringify,this.deserializeFn=e?.deserialize||JSON.parse,this.middleware={get:new u,set:new u,remove:new u};return}for(let o of i)try{if(o===y&&!s){this.idbStorage=new _(e?.namespace||"stosh_default");let l=i.filter(c=>c!==y);for(let c of l)try{let a=null;if(c===v?a=window.localStorage:c===b?a=window.sessionStorage:c===T?a=new g:c===p&&(a=new m),a&&c!==p){let h="__stosh_test_key__"+Math.random();a.setItem(h,"1"),a.removeItem(h)}if(a){t=a;break}}catch{continue}t||(t=new m);break}else o===v?t=window.localStorage:o===b?t=window.sessionStorage:o===T?t=new g:o===p&&(t=new m);if(t&&o!==p&&o!==y){let l="__stosh_test_key__"+Math.random();t.setItem(l,"1"),t.removeItem(l)}if(t){r=o===p;break}}catch{t=null;continue}!t&&!this.idbStorage?(t=new m,r=!0):!t&&this.idbStorage&&(t=new m,r=!0),this.storage=t,this.isMemoryFallback=r,this.namespace=e?.namespace?e.namespace+":":"",this.serializeFn=e?.serialize||JSON.stringify,this.deserializeFn=e?.deserialize||JSON.parse,this.middleware={get:new u,set:new u,remove:new u},!d.isSSR&&window.addEventListener&&(this.storage===window.localStorage||this.storage===window.sessionStorage)&&window.addEventListener("storage",o=>{if(o.key&&o.key.startsWith(this.namespace)&&this.onChangeCb){let l=this.stripNamespace(o.key),c=null;if(o.newValue)try{let a=this.deserializeFn(o.newValue);(!a.e||Date.now()<=a.e)&&(c=a.v)}catch{}this.triggerChange(l,c)}})}use(e,t){this.middleware[e].use(t)}runMiddlewareSync(e,t,r){this.middleware[e].runSync(t,r)}async runMiddleware(e,t,r){await this.middleware[e].run(t,r)}async _getInternal(e){let t={key:e},r=null;return await this.runMiddleware(I,t,async n=>{let s=this.namespace+n.key,i=null;if(this.idbStorage?i=await this.idbStorage.getItem(s):i=this.storage.getItem(s),!i)r=null;else try{let o=this.deserializeFn(i);o.e&&Date.now()>o.e?(this.idbStorage?this.idbStorage.removeItem(s).catch(console.error):this.storage.removeItem(s),r=null):r=o.v}catch{r=null}n.result=r}),t.result===void 0?null:t.result}_getInternalSync(e){let t={key:e},r=null;return this.runMiddlewareSync(I,t,n=>{let s=this.namespace+n.key,i=this.storage.getItem(s);if(!i)r=null;else try{let o=this.deserializeFn(i);o.e&&Date.now()>o.e?(this.storage.removeItem(s),r=null):r=o.v}catch{r=null}n.result=r}),t.result===void 0?null:t.result}async _setInternal(e,t,r){let n={key:e,value:t,options:r};await this.runMiddleware(O,n,async s=>{if(s.value===void 0){await this._removeInternal(s.key);return}let i={v:s.value,e:s.options?.expire?Date.now()+s.options.expire:void 0},o=this.serializeFn(i),l=this.namespace+s.key;this.storage instanceof g?this.storage.setItem(l,o,s.options):this.idbStorage?await this.idbStorage.setItem(l,o):this.storage.setItem(l,o),this.triggerChange(s.key,s.value)})}_setInternalSync(e,t,r){let n={key:e,value:t,options:r};this.runMiddlewareSync(O,n,s=>{if(s.value===void 0){this._removeInternalSync(s.key);return}let i={v:s.value,e:s.options?.expire?Date.now()+s.options.expire:void 0},o=this.namespace+s.key,l=this.serializeFn(i);this.storage instanceof g?this.storage.setItem(o,l,s.options):this.storage.setItem(o,l),this.triggerChange(s.key,s.value)})}async _removeInternal(e,t){let r={key:e,options:t};await this.runMiddleware(M,r,async n=>{let s=this.namespace+n.key;this.storage instanceof g?this.storage.removeItem(s,n.options):this.idbStorage?await this.idbStorage.removeItem(s):this.storage.removeItem(s),this.triggerChange(n.key,null)})}_removeInternalSync(e,t){let r={key:e,options:t};this.runMiddlewareSync(M,r,n=>{let s=this.namespace+n.key;this.storage instanceof g?this.storage.removeItem(s,n.options):this.storage.removeItem(s),this.triggerChange(n.key,null)})}async set(e,t,r){await this._setInternal(e,t,r)}async get(e){return this._getInternal(e)}async remove(e,t){await this._removeInternal(e,t)}setSync(e,t,r){this.idbStorage&&console.warn("[stosh] setSync called when IndexedDB is the primary storage. Operation will use the synchronous fallback storage (e.g., localStorage, memory)."),this._setInternalSync(e,t,r)}getSync(e){return this.idbStorage&&console.warn("[stosh] getSync called when IndexedDB is the primary storage. Operation will use the synchronous fallback storage (e.g., localStorage, memory)."),this._getInternalSync(e)}removeSync(e,t){this.idbStorage&&console.warn("[stosh] removeSync called when IndexedDB is the primary storage. Operation will use the synchronous fallback storage (e.g., localStorage, memory)."),this._removeInternalSync(e,t)}getNamespaceKeys(){return Array.from({length:this.storage.length}).map((e,t)=>this.storage.key(t)).filter(e=>!!e&&e.startsWith(this.namespace))}clearSync(){this.getNamespaceKeys().forEach(e=>{this._removeInternalSync(this.stripNamespace(e))})}async clear(){if(this.idbStorage){let e=(await this.idbStorage.getAllKeys()).filter(t=>t.startsWith(this.namespace)).map(t=>this.stripNamespace(t));await this.idbStorage.clear(),e.forEach(t=>this.triggerChange(t,null));return}this.clearSync()}async has(e){return await this.get(e)!==null}hasSync(e){return this.getSync(e)!==null}async getAll(){if(this.idbStorage){let e=await this.idbStorage.getDbPromise();return new Promise((t,r)=>{let n=e.transaction(this.idbStorage.getStoreName(),"readonly"),i=n.objectStore(this.idbStorage.getStoreName()).openCursor(),o={};i.onsuccess=async l=>{let c=l.target.result;if(c){let a=c.key;if(a.startsWith(this.namespace)){let h=this.stripNamespace(a),S=c.value,f=null;try{let w=this.deserializeFn(S);w.e&&Date.now()>w.e?(this.idbStorage.removeItem(a).catch(console.error),f=null):f=w.v}catch{f=null}let N={key:h,result:f};await this.runMiddleware(I,N,async w=>{w.result!==null&&w.result!==void 0&&(o[h]=w.result)})}c.continue()}else t(o)},i.onerror=()=>r(i.error),n.onerror=()=>r(n.error)})}return this.getAllSync()}getAllSync(){let e={};return this.getNamespaceKeys().forEach(r=>{let n=this.stripNamespace(r),s=this._getInternalSync(n);s!==null&&(e[n]=s)}),e}async batchSet(e,t){if(this.idbStorage){let r=[];for(let{key:s,value:i,options:o}of e){let l={...t,...o},c={key:s,value:i,options:l};await this.runMiddleware(O,c,async a=>{if(a.value===void 0)this.triggerChange(a.key,null);else{let h={v:a.value,e:a.options?.expire?Date.now()+a.options.expire:void 0};r.push({key:this.namespace+a.key,value:this.serializeFn(h)}),this.triggerChange(a.key,a.value)}})}r.length>0&&await this.idbStorage.batchSet(r);let n=e.filter(s=>s.value===void 0).map(s=>this.namespace+s.key);n.length>0&&await this.idbStorage.batchRemove(n);return}e.forEach(({key:r,value:n,options:s})=>{let i={...t,...s};this._setInternalSync(r,n,i)})}batchSetSync(e,t){e.forEach(({key:r,value:n,options:s})=>{let i={...t,...s};this._setInternalSync(r,n,i)})}async batchGet(e){if(this.idbStorage){let t=e.map(s=>this.namespace+s),r=await this.idbStorage.batchGet(t),n=new Array(e.length).fill(null);for(let s=0;s<e.length;s++){let i=e[s],o=r[s],l=null;if(o)try{let a=this.deserializeFn(o);a.e&&Date.now()>a.e?(this.idbStorage.removeItem(t[s]).catch(console.error),l=null):l=a.v}catch{l=null}let c={key:i,result:l};await this.runMiddleware(I,c,async a=>{n[s]=a.result===void 0?null:a.result})}return n}return this.batchGetSync(e)}batchGetSync(e){return e.map(t=>this._getInternalSync(t))}async batchRemove(e,t){if(this.idbStorage){let r=[];for(let n of e){let s={key:n,options:t};await this.runMiddleware(M,s,async i=>{r.push(this.namespace+i.key),this.triggerChange(i.key,null)})}r.length>0&&await this.idbStorage.batchRemove(r);return}e.forEach(r=>{this._removeInternalSync(r,t)})}batchRemoveSync(e,t){e.forEach(r=>{this._removeInternalSync(r,t)})}onChange(e){return this.onChangeCb=e,()=>{this.onChangeCb=void 0}}stripNamespace(e){return e.startsWith(this.namespace)?e.slice(this.namespace.length):e}triggerChange(e,t){if(this.onChangeCb)try{let r=this.onChangeCb(e,t);r instanceof Promise&&r.catch(n=>console.error("[stosh] Error in onChange callback:",n))}catch(r){console.error("[stosh] Error in onChange callback:",r)}}};function k(d){return new E(d)}k.isSSR=E.isSSR;return Y(z);})();
