"use strict";var stosh=(()=>{var g=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var M=(o,e)=>{for(var t in e)g(o,t,{get:e[t],enumerable:!0})},x=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of v(e))!b.call(o,r)&&r!==t&&g(o,r,{get:()=>e[r],enumerable:!(s=f(e,r))||s.enumerable});return o};var C=o=>x(g({},"__esModule",{value:!0}),o);var T={};M(T,{Stosh:()=>d,stosh:()=>S});var c=class{constructor(){this.store=new Map}get length(){return this.store.size}clear(){this.store.clear()}getItem(e){return this.store.has(e)?this.store.get(e):null}key(e){return Array.from(this.store.keys())[e]??null}removeItem(e){this.store.delete(e)}setItem(e,t){this.store.set(e,t)}},m=class{get length(){return document.cookie?document.cookie.split(";").length:0}clear(){let e=document.cookie.split(";");for(let t of e){let s=t.indexOf("="),r=s>-1?t.substr(0,s).trim():t.trim();r&&this.removeItem(r)}}getItem(e){let t=encodeURIComponent(e)+"=",s=document.cookie.split(";");for(let r of s)if(r=r.trim(),r.indexOf(t)===0)return decodeURIComponent(r.substring(t.length));return null}key(e){let t=document.cookie.split(";");if(e<0||e>=t.length)return null;let s=t[e].indexOf("=");return s>-1?decodeURIComponent(t[e].substr(0,s).trim()):null}removeItem(e){document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"}setItem(e,t){document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+"; path=/"}},u=class{constructor(e="stosh",t="store"){this.dbName=e,this.storeName=t,this.dbPromise=this.open()}getStoreName(){return this.storeName}getDbPromise(){return this.dbPromise}open(){return new Promise((e,t)=>{let s=indexedDB.open(this.dbName,1);s.onupgradeneeded=()=>{s.result.createObjectStore(this.storeName)},s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}async getItem(e){let t=await this.dbPromise;return new Promise((s,r)=>{let i=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);i.onsuccess=()=>s(i.result??null),i.onerror=()=>r(i.error)})}async setItem(e,t){let s=await this.dbPromise;return new Promise((r,a)=>{let l=s.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(t,e);l.onsuccess=()=>r(),l.onerror=()=>a(l.error)})}async removeItem(e){let t=await this.dbPromise;return new Promise((s,r)=>{let i=t.transaction(this.storeName,"readwrite").objectStore(this.storeName).delete(e);i.onsuccess=()=>s(),i.onerror=()=>r(i.error)})}};function w(o,e,t){let s=-1,r=()=>{s++,s<o.length?o[s](e,r):t(e)};r()}async function y(o,e,t){let s=0;async function r(){if(s<o.length){let a=o[s++];await a(e,r)}else await t(e)}await r()}var d=class{constructor(e){this.middlewares={get:[],set:[],remove:[]};let t=null,s=!1,r=["idb","local","session","cookie","memory"];if(e?.type&&!r.includes(e.type))throw new Error(`Unsupported storage type: ${e.type}`);let a=e?.type===void 0||e?.type.endsWith("Sync"),n=e?.priority||(e?.type?[e.type]:["idb","local","session","cookie","memory"]);if(a&&n.includes("idb")&&(n=n.filter(i=>i!=="idb"),typeof window<"u"&&window.console&&console.warn("[stosh] In synchronous API, idb (IndexedDB) cannot be used. Automatically switching to available storage among local/session/cookie/memory.")),typeof window>"u"){s=!0,this.storage=new c,this.isMemoryFallback=!0,this.namespace=e?.namespace?e.namespace+":":"",this.serializeFn=e?.serialize||JSON.stringify,this.deserializeFn=e?.deserialize||JSON.parse;return}for(let i of n)try{if(i==="local"?t=window.localStorage:i==="session"?t=window.sessionStorage:i==="cookie"?t=new m:i==="memory"?t=new c:i==="idb"&&(this.idbStorage=new u("stosh",e?.namespace||"store")),t&&i!=="memory"&&i!=="idb"){let l="__stosh_test_key__"+Math.random();t.setItem(l,"1"),t.removeItem(l)}s=i==="memory";break}catch{t=null;continue}t||(t=new c,s=!0),this.storage=t,this.isMemoryFallback=s,this.namespace=e?.namespace?e.namespace+":":"",this.serializeFn=e?.serialize||JSON.stringify,this.deserializeFn=e?.deserialize||JSON.parse,!s&&typeof window<"u"&&window.addEventListener&&window.addEventListener("storage",i=>{if(i.key&&i.key.startsWith(this.namespace)&&this.onChangeCb){let l=i.key.replace(this.namespace,""),h=i.newValue?this.deserialize(i.newValue):null;this.onChangeCb(l,h)}})}static get isSSR(){return typeof window>"u"}use(e,t){this.middlewares[e].push(t)}async runMiddleware(e,t,s){await y(this.middlewares[e],t,s)}runMiddlewareSync(e,t,s){w(this.middlewares[e],t,s)}async set(e,t,s){if(this.idbStorage){await this.runMiddleware("set",{key:e,value:t,options:s},async r=>{let a={v:r.value,e:r.options?.expire?Date.now()+r.options.expire:void 0};await this.idbStorage.setItem(this.namespace+e,this.serialize(a)),this.triggerChange(e,r.value===void 0?null:r.value)});return}this.setSync(e,t,s)}async get(e){if(this.idbStorage){let t=null,s={key:e};return await this.runMiddleware("get",s,async r=>{let a=await this.idbStorage.getItem(this.namespace+e);if(!a){t=null,r.result=t;return}try{let n=this.deserialize(a);n.e&&Date.now()>n.e?(await this.idbStorage.removeItem(this.namespace+e),t=null):t=n.v}catch{t=null}r.result=t}),t===void 0?null:t}return this.getSync(e)}async remove(e){if(this.idbStorage){await this.runMiddleware("remove",{key:e},async t=>{await this.idbStorage.removeItem(this.namespace+e),this.triggerChange(e,null)});return}this.removeSync(e)}setSync(e,t,s){this.runMiddlewareSync("set",{key:e,value:t,options:s},r=>{let a={v:r.value,e:r.options?.expire?Date.now()+r.options.expire:void 0};this.storage.setItem(this.namespace+e,this.serialize(a)),this.triggerChange(e,r.value===void 0?null:r.value)})}getSync(e){let t=null,s={key:e};return this.runMiddlewareSync("get",s,r=>{let a=this.storage.getItem(this.namespace+e);if(!a){t=null,r.result=t;return}try{let n=this.deserialize(a);n.e&&Date.now()>n.e?(this.storage.removeItem(this.namespace+e),t=null):t=n.v}catch{t=null}r.result=t}),s.result===void 0?null:s.result}removeSync(e){this.runMiddlewareSync("remove",{key:e},t=>{this.storage.removeItem(this.namespace+e),this.triggerChange(e,null)})}async clear(){if(this.idbStorage){let e=await this.idbStorage.dbPromise;return new Promise((t,s)=>{let n=e.transaction(this.idbStorage.getStoreName(),"readwrite").objectStore(this.idbStorage.getStoreName()).clear();n.onsuccess=()=>t(),n.onerror=()=>s(n.error)})}this.clearSync()}clearSync(){let e=Object.keys(this.storage).filter(t=>t.startsWith(this.namespace));for(let t of e)this.storage.removeItem(t),this.triggerChange(t.replace(this.namespace,""),null)}async has(e){return this.idbStorage?await this.get(e)!==null:this.hasSync(e)}hasSync(e){return this.getSync(e)!==null}async getAll(){if(this.idbStorage){let e=await this.idbStorage.getDbPromise();return new Promise((t,s)=>{let n=e.transaction(this.idbStorage.getStoreName(),"readonly").objectStore(this.idbStorage.getStoreName()).getAllKeys(),i={};n.onsuccess=async()=>{let l=n.result;for(let h of l){let p=await this.get(h);p!==null&&(i[h.replace(this.namespace,"")]=p)}t(i)},n.onerror=()=>s(n.error)})}return this.getAllSync()}getAllSync(){let e={};for(let t in this.storage)if(t.startsWith(this.namespace)){let s=t.replace(this.namespace,""),r=this.getSync(s);r!==null&&(e[s]=r)}return e}async batchSet(e){if(this.idbStorage){for(let{key:t,value:s,options:r}of e)await this.set(t,s,r);return}this.batchSetSync(e)}batchSetSync(e){for(let{key:t,value:s,options:r}of e)this.setSync(t,s,r)}async batchGet(e){if(this.idbStorage){let t=[];for(let s of e)t.push(await this.get(s));return t}return this.batchGetSync(e)}batchGetSync(e){return e.map(t=>this.getSync(t))}async batchRemove(e){if(this.idbStorage){for(let t of e)await this.remove(t);return}this.batchRemoveSync(e)}batchRemoveSync(e){for(let t of e)this.removeSync(t)}onChange(e){this.onChangeCb=e}serialize(e){return this.serializeFn(e)}deserialize(e){return this.deserializeFn(e)}triggerChange(e,t){this.onChangeCb&&this.onChangeCb(e,t)}};function S(o){return new d(o)}S.isSSR=d.isSSR;return C(T);})();
